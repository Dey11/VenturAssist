generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ----------------------------------------
// ENUMS for data integrity and consistency
// ----------------------------------------

/// Defines the type of asynchronous job to be processed by a worker.
enum JobType {
  EXTRACT_DATA_FROM_SOURCE
  SCRAPE_COMPETITOR_DATA
  BENCHMARK_AGAINST_PEERS
  GENERATE_RISK_ANALYSIS
  GENERATE_FINAL_SUMMARY
  REDLENS_RISK_ASSESSMENT
  COMPETITOR_ANALYSIS
}

/// Represents the status of any asynchronous job.
enum JobStatus {
  NOT_STARTED // not yet started, default state
  PENDING // queued for processing
  IN_PROGRESS
  COMPLETED
  FAILED
  RETRYING
}

/// Type of data source provided by the user.
enum DataSourceType {
  FILE_UPLOAD
  TEXT_INPUT
  URL
}

/// Severity level for identified risks.
enum RiskSeverity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

/// RedLens specialized risk assessment modules.
enum RedLensModule {
  FORENSIC_ACCOUNTANT
  MARKET_STRATEGIST
  TALENT_SCOUT
  DEVILS_ADVOCATE
}

model User {
  id            String   @id @default(cuid())
  name          String
  email         String   @unique
  emailVerified Boolean  @default(false)
  image         String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // RELATIONS
  sessions Session[]
  accounts Account[]
  startups Startup[] // A user can have multiple startup analysis projects.
}

model Session {
  id        String   @id @default(cuid())
  expiresAt DateTime
  token     String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  ipAddress String?
  userAgent String?
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Account {
  id                    String    @id @default(cuid())
  accountId             String
  providerId            String
  userId                String
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
}

model Verification {
  id         String   @id @default(cuid())
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @default(now()) @updatedAt
}

// ----------------------------------------
// CORE APPLICATION MODELS
// ----------------------------------------

/// The central entity for an analysis project.
/// Everything is anchored to a specific startup analysis.
model Startup {
  id              String    @id @default(cuid())
  name            String
  description     String?
  websiteUrl      String?
  overallStatus   JobStatus @default(NOT_STARTED) /// High-level status of the entire analysis pipeline.
  finalSummary    String? /// The final investor-ready summary generated by the AI.
  recommendation  String? /// e.g., "Proceed with due diligence", "Monitor", "Pass"
  confidenceScore Float? /// A score from 0 to 1 on the recommendation.

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // RELATIONS
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  dataSources        DataSource[]
  jobs               Job[]
  teamMembers        TeamMember[]
  keyMetrics         KeyMetric[]
  marketInfo         MarketInfo? // A startup likely has one primary market analysis.
  benchmarks         Benchmark[]
  risks              RiskIndicator[]
  chatHistory        ChatMessage[]
  OnboardingResponse OnboardingResponse[]
  redLensAssessment  RedLensAssessment?
  competitorAnalysis CompetitorAnalysis?

  @@index([userId])
}

enum OnboardingQuestionKey {
  SECTOR
  STAGE
}

/// Stores the structured responses from the VC's onboarding form.
/// This key-value approach is flexible and avoids schema migrations when questions change.
model OnboardingResponse {
  id           String                @id @default(cuid())
  questionKey  OnboardingQuestionKey /// A unique key for the question, e.g., "sector" or "stage"
  questionText String /// The full question text, e.g., "What is the core business model?"
  answerValue  Json /// The answer, stored as JSON to accommodate text, numbers, or arrays (for multi-select).

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // RELATIONS
  startupId String
  startup   Startup @relation(fields: [startupId], references: [id], onDelete: Cascade)

  @@unique([startupId, questionKey]) // Ensures one answer per question for each startup
  @@index([startupId])
}

/// Represents a piece of information uploaded by the user (deck, transcript, url).
model DataSource {
  id        String         @id @default(cuid())
  type      DataSourceType
  fileName  String? /// Original name of the uploaded file.
  sourceUrl String? /// URL for FILE (in object storage) or URL type.
  content   String? /// For TEXT_INPUT type.
  status    JobStatus      @default(NOT_STARTED) /// Status of the initial ingestion/processing for this source.

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // RELATIONS
  startupId String
  startup   Startup @relation(fields: [startupId], references: [id], onDelete: Cascade)

  // A data source can be associated with multiple jobs.
  jobs Job[]

  @@index([startupId])
}

/// Generic model to track any asynchronous task in the system.
/// This is key for scalability and observability.
model Job {
  id          String    @id @default(cuid())
  type        JobType
  status      JobStatus @default(PENDING)
  payload     Json? /// Input for the job, e.g., { "fileUrl": "...", "dataSourceId": "..." }
  result      Json? /// Output of the job, e.g., { "metricsExtracted": 5, "teamMembersFound": 3 }
  logs        String? /// Store error messages or processing logs.
  startedAt   DateTime?
  completedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // RELATIONS
  startupId String
  startup   Startup @relation(fields: [startupId], references: [id], onDelete: Cascade)

  // A job can be associated with multiple data sources.
  dataSources DataSource[]

  @@index([startupId])
  @@index([status])
  @@index([type])
}

// ----------------------------------------
// STRUCTURED DATA MODELS (Populated by Ingestor Agent)
// ----------------------------------------

/// Stores information about team members extracted from data sources.
model TeamMember {
  id          String  @id @default(cuid())
  name        String
  role        String?
  linkedInUrl String?
  bioSummary  String? /// AI-generated summary of their experience.

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // RELATIONS
  startupId String
  startup   Startup @relation(fields: [startupId], references: [id], onDelete: Cascade)

  @@index([startupId])
}

/// Stores key metrics (e.g., MRR, Churn) extracted from sources.
model KeyMetric {
  id           String  @id @default(cuid())
  name         String /// e.g., "Monthly Recurring Revenue"
  value        String /// Stored as string to accommodate formats like "$50k" or "20%".
  unit         String? /// e.g., "USD", "%"
  reportedDate String? /// Date the metric was reported, if available (stored as string for flexibility).
  insight      String? /// AI-generated comment on the metric's significance.

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // RELATIONS
  startupId String
  startup   Startup @relation(fields: [startupId], references: [id], onDelete: Cascade)

  @@index([startupId])
}

/// Stores market size information (TAM, SAM, SOM).
model MarketInfo {
  id       String  @id @default(cuid())
  tam      String? /// Total Addressable Market
  sam      String? /// Serviceable Available Market
  som      String? /// Serviceable Obtainable Market
  analysis String? /// AI's analysis of the market sizing claims.

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // RELATIONS
  startupId String  @unique // Each startup has only one market info record.
  startup   Startup @relation(fields: [startupId], references: [id], onDelete: Cascade)
}

// ----------------------------------------
// ANALYSIS & INSIGHT MODELS (Populated by other Agents)
// ----------------------------------------

/// Stores benchmarking results comparing the startup to peers.
model Benchmark {
  id                String @id @default(cuid())
  metricName        String /// e.g., "Team Size Growth (6mo)"
  startupValue      String
  competitorAverage String
  insight           String /// AI-generated explanation of the comparison.

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // RELATIONS
  startupId String
  startup   Startup @relation(fields: [startupId], references: [id], onDelete: Cascade)

  @@index([startupId])
}

/// Stores potential risks or red flags identified by the AI.
model RiskIndicator {
  id          String       @id @default(cuid())
  riskTitle   String /// e.g., "Inconsistent Metrics", "Inflated Market Size"
  explanation String
  severity    RiskSeverity

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // RELATIONS
  startupId String
  startup   Startup @relation(fields: [startupId], references: [id], onDelete: Cascade)

  @@index([startupId])
}

// ----------------------------------------
// INTERACTIVE AGENT MODELS
// ----------------------------------------

/// Stores the conversation history for the chat feature.
model ChatMessage {
  id      String @id @default(cuid())
  role    String /// "user" or "assistant"
  content String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // RELATIONS
  startupId String
  startup   Startup @relation(fields: [startupId], references: [id], onDelete: Cascade)

  @@index([startupId])
}

// ----------------------------------------
// REDLENS RISK ASSESSMENT MODELS
// ----------------------------------------

/// Stores comprehensive risk assessment results from RedLens modules.
model RedLensAssessment {
  id              String  @id @default(cuid())
  overallScore    Float? /// Overall risk score from 0-1 (0 = low risk, 1 = high risk)
  summary         String? /// Executive summary of all risk findings
  recommendation  String? /// Final recommendation based on risk assessment
  confidenceScore Float? /// Confidence in the assessment (0-1)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // RELATIONS
  startupId String  @unique // Each startup has only one RedLens assessment
  startup   Startup @relation(fields: [startupId], references: [id], onDelete: Cascade)

  moduleAssessments RedLensModuleAssessment[]

  @@index([startupId])
}

/// Stores individual module assessment results.
model RedLensModuleAssessment {
  id              String        @id @default(cuid())
  module          RedLensModule /// Which specialized module performed this assessment
  score           Float? /// Module-specific risk score (0-1)
  findings        String[] /// Array of specific findings/risks identified
  recommendations String[] /// Array of recommendations from this module
  confidence      Float? /// Confidence in this module's assessment (0-1)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // RELATIONS
  redLensAssessmentId String
  redLensAssessment   RedLensAssessment @relation(fields: [redLensAssessmentId], references: [id], onDelete: Cascade)

  @@index([redLensAssessmentId])
  @@index([module])
}

// ----------------------------------------
// COMPETITOR ANALYSIS MODELS
// ----------------------------------------

/// Stores competitor analysis results for a startup.
model CompetitorAnalysis {
  id                   String   @id @default(cuid())
  overallScore         Float? /// Overall competitive positioning score (0-1)
  marketPosition       String? /// Market position description
  competitiveAdvantage String? /// Key competitive advantages identified
  threats              String[] /// Array of competitive threats
  opportunities        String[] /// Array of market opportunities
  recommendations      String[] /// Array of strategic recommendations
  confidenceScore      Float? /// Confidence in the analysis (0-1)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // RELATIONS
  startupId String  @unique // Each startup has only one competitor analysis
  startup   Startup @relation(fields: [startupId], references: [id], onDelete: Cascade)

  competitors Competitor[] /// List of identified competitors

  @@index([startupId])
}

/// Stores information about individual competitors.
model Competitor {
  id              String   @id @default(cuid())
  name            String /// Competitor company name
  website         String? /// Competitor website URL
  description     String? /// Brief description of the competitor
  marketPosition  String? /// Their position in the market
  strengths       String[] /// Array of competitor strengths
  weaknesses      String[] /// Array of competitor weaknesses
  similarityScore Float? /// How similar they are to our startup (0-1)
  threatLevel     String? /// Threat level: LOW, MEDIUM, HIGH, CRITICAL
  funding         String? /// Recent funding information if available
  employees       String? /// Company size information if available
  founded         String? /// Founded date if available

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // RELATIONS
  competitorAnalysisId String
  competitorAnalysis   CompetitorAnalysis @relation(fields: [competitorAnalysisId], references: [id], onDelete: Cascade)

  @@index([competitorAnalysisId])
  @@index([name])
}
